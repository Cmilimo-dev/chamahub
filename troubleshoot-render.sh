#!/bin/bash

# Render Deployment Troubleshooting Script

set -e

echo "ğŸ” Troubleshooting Render Deployment Issues"
echo "=========================================="

# Check if logged in
if ! render whoami &> /dev/null; then
    echo "âŒ Not logged in to Render. Please run 'render login' first."
    exit 1
fi

echo "âœ… Logged in to Render"

# Check repository access
REPO_URL="https://github.com/Cmilimo-dev/chamahub"
echo "ğŸ” Checking repository access..."
if curl -s -o /dev/null -w "%{http_code}" "$REPO_URL" | grep -q "200"; then
    echo "âœ… Repository accessible: $REPO_URL"
else
    echo "âŒ Repository not accessible: $REPO_URL"
fi

# Check branch
echo "ğŸ” Checking branch..."
git branch -a | grep -q "main" && echo "âœ… Main branch exists" || echo "âŒ Main branch missing"

# Check render.yaml syntax
echo "ğŸ” Checking render.yaml syntax..."
if [ -f "render.yaml" ]; then
    echo "âœ… render.yaml exists"
    
    # Basic syntax check
    if grep -q "services:" render.yaml && grep -q "databases:" render.yaml; then
        echo "âœ… render.yaml has required sections"
    else
        echo "âŒ render.yaml missing required sections"
    fi
    
    # Check for repository configuration
    if grep -q "repo:" render.yaml && grep -q "branch:" render.yaml; then
        echo "âœ… render.yaml has repository configuration"
    else
        echo "âŒ render.yaml missing repository configuration"
    fi
else
    echo "âŒ render.yaml not found"
fi

# Check for required files
echo "ğŸ” Checking required files..."
[ -f "backend-package.json" ] && echo "âœ… backend-package.json exists" || echo "âŒ backend-package.json missing"
[ -f "server-postgres.js" ] && echo "âœ… server-postgres.js exists" || echo "âŒ server-postgres.js missing"

# Check if changes are pushed
echo "ğŸ” Checking git status..."
if git status --porcelain | grep -q .; then
    echo "âš ï¸  Uncommitted changes detected"
    git status --porcelain
else
    echo "âœ… No uncommitted changes"
fi

# Check if branch is up to date
echo "ğŸ” Checking if branch is up to date..."
git fetch origin
if git status | grep -q "up to date"; then
    echo "âœ… Branch is up to date"
else
    echo "âš ï¸  Branch may not be up to date"
    git status
fi

echo ""
echo "ğŸ› ï¸  SOLUTIONS FOR COMMON ISSUES:"
echo "================================"
echo ""
echo "1. Branch not found error:"
echo "   - Ensure render.yaml has correct repo and branch"
echo "   - Check that repository is public or connected to Render"
echo ""
echo "2. DATABASE_URL environment variable:"
echo "   - This is auto-generated by Render when database is created"
echo "   - Ensure database section exists in render.yaml"
echo "   - Database must be created before web service"
echo ""
echo "3. Build failures:"
echo "   - Check that backend-package.json exists"
echo "   - Ensure server-postgres.js has no syntax errors"
echo "   - Verify Node.js version compatibility"
echo ""
echo "ğŸ“‹ Next steps:"
echo "1. Commit and push any changes"
echo "2. Try deploying again via Render Dashboard"
echo "3. Check Render logs for detailed error messages"
echo ""
echo "ğŸ”§ Manual deployment steps:"
echo "1. Go to https://dashboard.render.com"
echo "2. Click 'New' â†’ 'Blueprint'"
echo "3. Select repository: Cmilimo-dev/chamahub"
echo "4. Review and deploy"
